name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-assets:
    name: Build ${{ matrix.goos }}-${{ matrix.goarch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-14
            goos: darwin
            goarch: amd64
          - runner: macos-14
            goos: darwin
            goarch: arm64
          - runner: ubuntu-latest
            goos: linux
            goarch: amd64
          - runner: ubuntu-latest
            goos: linux
            goarch: arm64
            cc: aarch64-linux-gnu-gcc
            cxx: aarch64-linux-gnu-g++
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version-file: go.mod

      - name: Install Linux arm64 cross compiler
        if: runner.os == 'Linux' && matrix.goarch == 'arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Build binary
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6
        with:
          version: "~> v2"
          args: build --clean --single-target --output dist/ap
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: "1"
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}

      - name: Package tarball
        id: package
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          ARTIFACT="ap_${VERSION}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz"
          tar -czf "${ARTIFACT}" -C dist ap
          echo "artifact=${ARTIFACT}" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ${{ steps.package.outputs.artifact }}
          path: ${{ steps.package.outputs.artifact }}
          if-no-files-found: error

  publish-release:
    name: Publish release assets
    needs: build-assets
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          pattern: ap_*.tar.gz
          path: dist/release
          merge-multiple: true

      - name: Prepare checksums
        run: |
          cd dist/release
          sha256sum ap_*.tar.gz > checksums.txt

      - name: Ensure release exists
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if ! gh release view "$GITHUB_REF_NAME" --repo "$GITHUB_REPOSITORY" >/dev/null 2>&1; then
            gh release create "$GITHUB_REF_NAME" --title "$GITHUB_REF_NAME" --generate-notes --repo "$GITHUB_REPOSITORY"
          fi

      - name: Upload release files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "$GITHUB_REF_NAME" dist/release/ap_*.tar.gz dist/release/checksums.txt --clobber --repo "$GITHUB_REPOSITORY"
